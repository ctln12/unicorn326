<h1>Choose your tutor</h1>

<p><%= pluralize(@tutors_nb, 'result') %></p>

<div class="row">
  <div class="col-4">
    <div style="position: sticky; top: 30px;">
      <%= form_tag tutors_path, method: :get do %>
        <p>Subject</p>
        <%= select_tag(:subject, options_for_select(Subject.pluck(:name), selected: params[:subject]), {class: "selectpicker w-75", data: {"live-search": true, "style": "bg-white rounded-pill px-4 py-3 shadow-sm"}, include_blank: 'All'}) %>
        <p>Language</p>
        <%= select_tag(:language, options_for_select(Language.pluck(:name), selected: params[:language]),  {class: "selectpicker w-75", data: {"live-search": true, "style": "bg-white rounded-pill px-4 py-3 shadow-sm"}, include_blank: 'All'}) %>
        <p>Country</p>
        <%= select_tag(:country, options_for_select(ISO3166::Country.all.sort, selected: params[:country]),  {class: "selectpicker w-75", data: {"live-search": true, "style": "bg-white rounded-pill px-4 py-3 shadow-sm"}, include_blank: 'All'}) %>
        <div class="mt-3">
          <%= submit_tag "Search", class: "btn btn-primary" %>
        </div>
      <% end %>
      <%= link_to "Can't find your tutor ?", job_posts_path %>
    </div>
  </div>
  <div class="col">
    <% @tutors.each do |tutor| %>
      <div id="<%= tutor.id %>" class="tutor">
        <h4 class="name"><%= tutor.first_name %> <%= tutor.last_name %></h4>
        <p class="country"><%= ISO3166::Country.find_country_by_alpha2("#{tutor.country}").unofficial_names.first %></p>
        <p class="price"><%= tutor.price %> <%= Currency.find(tutor.currency_id).name %> / h</p>
        <p class="subject">Teaches:
          <% tutor.taught_lessons.each do |taught_lesson| %>
            <% separator = taught_lesson == tutor.taught_lessons.last ? '' : ',' %>
            <span><%= taught_lesson.subject.name %><%= separator %></span>
          <% end %>
        </p>
        <p class="language">Speaks:
          <% tutor.spoken_languages.each do |spoken_language| %>
            <% separator = spoken_language == tutor.spoken_languages.last ? '' : ',' %>
            <span><%= spoken_language.language.name %><%= separator %></span>
          <% end %>
        </p>
        <p class="rating">Rating:
          <% if tutor.reviews.exists? %>
            <span class="review-avg-rating" data-score="<%= average_rating(tutor.reviews) %>"></span>
          <% else %>
            <%= "Not rated yet" %>
          <% end %>
        </p>
        <%= link_to "View profile", tutor_path(tutor), class: "btn btn-primary" %>
        <hr>
      </div>
    <% end %>
  </div>
</div>

<script>
  jQuery(function() {
    $('.review-avg-rating').raty({
      readOnly: true,
      score: function() {
        return $(this).attr('data-score');
      },
      path: '/assets/'
    })
  });
</script>
